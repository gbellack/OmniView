#include "display_driver.h"

/* Common includes */
#include <stdint.h>
#include <string.h>

// Driverlib includes
#include "hw_types.h"
#include "hw_ints.h"
#include "hw_memmap.h"
#include "hw_common_reg.h"
#include "rom.h"
#include "rom_map.h"
#include "interrupt.h"
#include "prcm.h"
#include "utils.h"
#include "uart.h"

// Common interface includes
#ifndef NOTERM
	#include "uart_if.h"
#endif
#include "i2c_if.h"

#define UART_PRINT	Report

/* Buffer that stores the image. */
static uint8_t buffer[SSD1306_LCDHEIGHT * SSD1306_LCDWIDTH / 8] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
	0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x80, 0x80, 0xC0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF8, 0xFC, 0xF8, 0xE0, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0xFF,
	0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00,
	0x80, 0xFF, 0xFF, 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x80, 0x80,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x8C, 0x8E, 0x84, 0x00, 0x00, 0x80, 0xF8,
	0xF8, 0xF8, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x80,
	0x00, 0xE0, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xC7, 0x01, 0x01,
	0x01, 0x01, 0x83, 0xFF, 0xFF, 0x00, 0x00, 0x7C, 0xFE, 0xC7, 0x01, 0x01, 0x01, 0x01, 0x83, 0xFF,
	0xFF, 0xFF, 0x00, 0x38, 0xFE, 0xC7, 0x83, 0x01, 0x01, 0x01, 0x83, 0xC7, 0xFF, 0xFF, 0x00, 0x00,
	0x01, 0xFF, 0xFF, 0x01, 0x01, 0x00, 0xFF, 0xFF, 0x07, 0x01, 0x01, 0x01, 0x00, 0x00, 0x7F, 0xFF,
	0x80, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x7F, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x01, 0xFF,
	0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x03, 0x0F, 0x3F, 0x7F, 0x7F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xE7, 0xC7, 0xC7, 0x8F,
	0x8F, 0x9F, 0xBF, 0xFF, 0xFF, 0xC3, 0xC0, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFC, 0xFC, 0xFC,
	0xFC, 0xFC, 0xFC, 0xFC, 0xFC, 0xF8, 0xF8, 0xF0, 0xF0, 0xE0, 0xC0, 0x00, 0x01, 0x03, 0x03, 0x03,
	0x03, 0x03, 0x01, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01,
	0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x03, 0x03, 0x03, 0x01, 0x01, 0x03, 0x03, 0x00, 0x00,
	0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
	0x03, 0x03, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x01, 0x03, 0x01, 0x00, 0x00, 0x00, 0x03,
	0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF9, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3F, 0x1F, 0x0F,
	0x87, 0xC7, 0xF7, 0xFF, 0xFF, 0x1F, 0x1F, 0x3D, 0xFC, 0xF8, 0xF8, 0xF8, 0xF8, 0x7C, 0x7D, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0x0F, 0x07, 0x00, 0x30, 0x30, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xC0, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0xC0, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0x7F, 0x3F, 0x1F,
	0x0F, 0x07, 0x1F, 0x7F, 0xFF, 0xFF, 0xF8, 0xF8, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xF8, 0xE0,
	0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00,
	0x00, 0xFC, 0xFE, 0xFC, 0x0C, 0x06, 0x06, 0x0E, 0xFC, 0xF8, 0x00, 0x00, 0xF0, 0xF8, 0x1C, 0x0E,
	0x06, 0x06, 0x06, 0x0C, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00, 0x00, 0x00, 0xFC,
	0xFE, 0xFC, 0x00, 0x18, 0x3C, 0x7E, 0x66, 0xE6, 0xCE, 0x84, 0x00, 0x00, 0x06, 0xFF, 0xFF, 0x06,
	0x06, 0xFC, 0xFE, 0xFC, 0x0C, 0x06, 0x06, 0x06, 0x00, 0x00, 0xFE, 0xFE, 0x00, 0x00, 0xC0, 0xF8,
	0xFC, 0x4E, 0x46, 0x46, 0x46, 0x4E, 0x7C, 0x78, 0x40, 0x18, 0x3C, 0x76, 0xE6, 0xCE, 0xCC, 0x80,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x07, 0x0F, 0x1F, 0x1F, 0x3F, 0x3F, 0x3F, 0x3F, 0x1F, 0x0F, 0x03,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00,
	0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0x03, 0x07, 0x0E, 0x0C,
	0x18, 0x18, 0x0C, 0x06, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x01, 0x0F, 0x0E, 0x0C, 0x18, 0x0C, 0x0F,
	0x07, 0x01, 0x00, 0x04, 0x0E, 0x0C, 0x18, 0x0C, 0x0F, 0x07, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00,
	0x00, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x07,
	0x07, 0x0C, 0x0C, 0x18, 0x1C, 0x0C, 0x06, 0x06, 0x00, 0x04, 0x0E, 0x0C, 0x18, 0x0C, 0x0F, 0x07,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

/* EFFECTS: Initializes the I2C pins and set up the display configurations. */
void InitializeDisplay() {

	UART_PRINT("Starting Initialize Display\n\r");

    /* CC3200 - I2C Init to fast mode */
    I2C_IF_Open(I2C_MASTER_MODE_FST);

    UART_PRINT("Opened I2C\n\r");

	// Power on sequence.
	#ifdef RESET_I2C_DISPLAY_PIN

		// Configure reset pin and set its direction.
		MAP_PinTypeGPIO(DISPLAY_RESET_PIN, PIN_MODE_0, false);
		MAP_GPIODirModeSet(GPIOA1_BASE, 0x4, GPIO_DIR_MODE_OUT);

		/* Set RESET PIN to high for GPIO output. */
		GPIOPinWrite(GPIOA1_BASE, DISPLAY_RESET_PIN, 1);

		// TODO - Figure out delays (might need freeRTOS implementation here)...
		// VDD (3.3V) goes high at start, lets just chill for a ms
		delay(1);

		/* Bring reset low */
		GPIOPinWrite(GPIOA1_BASE, DISPLAY_RESET_PIN, 0);

		// wait 10ms
		delay(10);

		// bring out of reset
		GPIOPinWrite(GPIOA1_BASE, DISPLAY_RESET_PIN, 1);

	#endif

	// Init sequence for 128x64 OLED module
//	Send(SSD1306_DISPLAYOFF);                    // 0xAE
//	Send(SSD1306_SETDISPLAYCLOCKDIV);            // 0xD5
//	Send(0x80);                                  // the suggested ratio 0x80
//	Send(SSD1306_SETMULTIPLEX);                  // 0xA8
//	Send(0x3F);
//	Send(SSD1306_SETDISPLAYOFFSET);              // 0xD3
//	Send(0x0);                                   // no offset
//	Send(SSD1306_SETSTARTLINE | 0x0);            // line #0
//	Send(SSD1306_CHARGEPUMP);                    // 0x8D
//
//	// TODO - Not sure what this does...
////    if (vccstate == SSD1306_EXTERNALVCC) {
////    	Send(0x10);
////    }
////    else
////    {
////    	Send(0x14);
////    }
//
//    Send(SSD1306_MEMORYMODE);                    // 0x20
//    Send(0x00);                                  // 0x0 act like ks0108
//    Send(SSD1306_SEGREMAP | 0x1);
//    Send(SSD1306_COMSCANDEC);
//    Send(SSD1306_SETCOMPINS);                    // 0xDA
//    Send(0x12);
//    Send(SSD1306_SETCONTRAST);                   // 0x81
//
////    if (vccstate == SSD1306_EXTERNALVCC)
////    {
////    	Send(0x9F);
////    }
////    else
////    {
////    	Send(0xCF);
////    }
//
//    Send(SSD1306_SETPRECHARGE);                  // 0xd9
//
////    if (vccstate == SSD1306_EXTERNALVCC)
////    {
////    	Send(0x22);
////    }
////    else
////    {
////    	Send(0xF1);
////    }
//
//    Send(SSD1306_SETVCOMDETECT);                 // 0xDB
//    Send(0x40);
//    Send(SSD1306_DISPLAYALLON_RESUME);           // 0xA4
//    Send(SSD1306_NORMALDISPLAY);                 // 0xA6

    DisplayOn();
}

/* EFFECTS: Send and receive the payload */
void Send(uint8_t payload) {

	unsigned char temp = 0x00;
	I2C_IF_Write(SSD1306_I2C_ADDRESS, &temp, 1, 1); // Co = 0, D/C = 0
	I2C_IF_Write(SSD1306_I2C_ADDRESS, (unsigned char *)payload, 1, 1);
}

/* EFFECTS: Clears the display. */
void ClearDisplay() {
	memset(buffer, 0, (SSD1306_LCDWIDTH*SSD1306_LCDHEIGHT/8));
}

/* EFFECTS: Displays whatever that is stored in buffer */
void Display() {

	Send(SSD1306_COLUMNADDR);
	Send(0);   // Column start address (0 = reset)
	Send(SSD1306_LCDWIDTH-1); // Column end address (127 = reset)

	Send(SSD1306_PAGEADDR);
	Send(0); // Page start address (0 = reset)

	Send(7); // Page end address

	// save I2C bitrate
	unsigned char temp = 0x40;

	uint16_t i = 0;
	for (i = 0; i < (SSD1306_LCDWIDTH * SSD1306_LCDHEIGHT / 8); ++i) {
		// send a bunch of data in one xmission

		I2C_IF_Write(SSD1306_I2C_ADDRESS, &temp, 1, 1);

		uint8_t x = 0;
		for (x = 0; x < 16; ++x) {
			I2C_IF_Write(SSD1306_I2C_ADDRESS, (unsigned char *)buffer[i], 1, 1);
			++i;
		}
		--i;
	}
}

void InvertDisplay() {
//	if (i) {
//		Send(SSD1306_INVERTDISPLAY);
//	}
//	else {
//		Send(SSD1306_NORMALDISPLAY);
//	}
}

/* EFFECTS: Turns the display on. */
void DisplayOn() {
	Send(SSD1306_DISPLAYON);
}

/* EFFECTS: Turns off the display. */
void DisplayOff() {
	Send(SSD1306_DISPLAYOFF);
}

void StartScrollRight(uint8_t start, uint8_t stop) {

	Send(SSD1306_RIGHT_HORIZONTAL_SCROLL);
	Send(0x00);
	Send(start);
	Send(0x00);
	Send(stop);
	Send(0x00);
	Send(0xFF);
	Send(SSD1306_ACTIVATE_SCROLL);
}

void StartScrollLeft(uint8_t start, uint8_t stop) {

	Send(SSD1306_LEFT_HORIZONTAL_SCROLL);
	Send(0x00);
	Send(start);
	Send(0x00);
	Send(stop);
	Send(0x00);
	Send(0xFF);
	Send(SSD1306_ACTIVATE_SCROLL);
}

void StopScroll() {
	Send(SSD1306_DEACTIVATE_SCROLL);
}

void Dim(int dim) {

//	uint8_t contrast;
//
//	if (dim) {
//		contrast = 0; // Dimmed display
//	}
//	else {
//		if (_vccstate == SSD1306_EXTERNALVCC) {
//			contrast = 0x9F;
//		}
//		else {
//			contrast = 0xCF;
//		}
//	}
//
//	// the range of contrast to too small to be really useful
//	// it is useful to dim the display
//	Send(SSD1306_SETCONTRAST);
//	Send(contrast);
}

/* REQUIRES: the x, y, and color.
 * EFFECTS: Sets a pixel based on its coordinate.
 */
void DrawPixel(int16_t x, int16_t y, uint16_t color) {

	/* Input validation - Check if x and y are within bounds */
	if ((x < 0) || (x >= SSD1306_LCDWIDTH) || (y < 0) || (y >= SSD1306_LCDHEIGHT))
		return;

	switch (color)
	{
		case WHITE:
			buffer[x+ (y/8)*SSD1306_LCDWIDTH] |=  (1 << (y & 7));
			break;
		case BLACK:
			buffer[x+ (y/8)*SSD1306_LCDWIDTH] &= ~(1 << (y & 7));
			break;
		case INVERSE:
			buffer[x+ (y/8)*SSD1306_LCDWIDTH] ^=  (1 << (y&7));
			break;
	}
}
